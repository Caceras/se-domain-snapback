{% extends "base.html" %}

{% block content %}
<div id="status-banner" class="status-banner status-idle">
    <span>&#10003;</span> System ready
</div>

{% if latest_data %}
<div class="stats">
    <div class="stat-card">
        <div class="stat-value">{{ latest_data.total_domains }}</div>
        <div class="stat-label">Valuable Domains Found</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ reports|length }}</div>
        <div class="stat-label">Historical Reports</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="indexed-count">{{ latest_data.domains|selectattr('indexed')|list|length }}</div>
        <div class="stat-label">Indexed Domains</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="se-count">{{ latest_data.domains|selectattr('tld', 'equalto', 'se')|list|length }}</div>
        <div class="stat-label">.se Domains</div>
    </div>
</div>

<div class="card">
    <h2><span class="icon">&#128202;</span> Latest Scan Results ({{ reports[0].date if reports else 'N/A' }})</h2>
    
    <div class="toolbar">
        <div class="toolbar-left">
            <button id="scan-btn" class="btn" onclick="startScan()">Run New Scan</button>
            {% if reports %}
            <a href="/report/{{ reports[0].date }}" class="btn btn-secondary">View Full Report</a>
            {% endif %}
        </div>
    </div>

    {% if latest_data.domains %}
    <div class="toolbar">
        <div class="toolbar-left">
            <div class="search-box">
                <span class="search-icon">&#128269;</span>
                <input type="text" id="search" placeholder="Search domains..." aria-label="Search domains">
                <button class="clear-btn" id="clear-search" onclick="clearSearch()" aria-label="Clear search">&#10005;</button>
            </div>
        </div>
        <div class="toolbar-right">
            <div class="filter-bar">
                <label>Filter:</label>
                <button class="chip active" onclick="filterTLD('all', this)" data-filter="all">
                    All <span class="count" id="count-all">{{ latest_data.domains|length }}</span>
                </button>
                <button class="chip" onclick="filterTLD('se', this)" data-filter="se">
                    .se <span class="count" id="count-se">{{ latest_data.domains|selectattr('tld', 'equalto', 'se')|list|length }}</span>
                </button>
                <button class="chip" onclick="filterTLD('nu', this)" data-filter="nu">
                    .nu <span class="count" id="count-nu">{{ latest_data.domains|selectattr('tld', 'equalto', 'nu')|list|length }}</span>
                </button>
            </div>
        </div>
    </div>

    <div class="result-count" id="result-count">Showing {{ [latest_data.domains|length, 50]|min }} of {{ latest_data.domains|length }} domains</div>

    <div class="table-wrapper">
        <table id="domains-table">
            <thead>
                <tr>
                    <th class="sortable" onclick="sortTable(0)" tabindex="0" role="button" onkeypress="if(event.key==='Enter')sortTable(0)">Domain <span class="sort-icon">&#8693;</span></th>
                    <th class="sortable" onclick="sortTable(1)" tabindex="0" role="button" onkeypress="if(event.key==='Enter')sortTable(1)">TLD <span class="sort-icon">&#8693;</span></th>
                    <th class="sortable" onclick="sortTable(2)" tabindex="0" role="button" onkeypress="if(event.key==='Enter')sortTable(2)">Release Date <span class="sort-icon">&#8693;</span></th>
                    <th class="sortable" onclick="sortTable(3)" tabindex="0" role="button" onkeypress="if(event.key==='Enter')sortTable(3)">Indexed Pages <span class="sort-icon">&#8693;</span></th>
                    <th class="sortable" onclick="sortTable(4)" tabindex="0" role="button" onkeypress="if(event.key==='Enter')sortTable(4)">Source <span class="sort-icon">&#8693;</span></th>
                    <th class="sortable" onclick="sortTable(5)" tabindex="0" role="button" onkeypress="if(event.key==='Enter')sortTable(5)">Status <span class="sort-icon">&#8693;</span></th>
                </tr>
            </thead>
            <tbody>
                {% for domain in latest_data.domains[:50] %}
                <tr data-tld="{{ domain.tld }}">
                    <td><strong>{{ domain.domain }}</strong></td>
                    <td><span class="tld-{{ domain.tld }}">.{{ domain.tld }}</span></td>
                    <td>{{ domain.release_date }}</td>
                    <td>
                        {% if domain.estimated_pages %}
                            <strong>{{ domain.estimated_pages }}</strong>
                        {% else %}
                            <span style="color: var(--text-muted);">-</span>
                        {% endif %}
                    </td>
                    <td>{{ domain.index_source }}</td>
                    <td>
                        {% if domain.indexed %}
                            <span class="badge badge-success">Indexed</span>
                        {% else %}
                            <span class="badge badge-warning">Not Indexed</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {% if latest_data.domains|length > 50 %}
    <p style="margin-top: 1rem; text-align: center;">
        <a href="/report/{{ reports[0].date }}" class="btn btn-secondary">
            View all {{ latest_data.domains|length }} domains
        </a>
    </p>
    {% endif %}
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">&#128269;</div>
        <p>No domains found in the latest scan.</p>
    </div>
    {% endif %}
</div>
{% else %}
<div class="card">
    <h2>No Reports Available</h2>
    <div class="empty-state">
        <div class="empty-icon">&#128640;</div>
        <p>No scan results found. Run your first scan to get started!</p>
        <button id="scan-btn" class="btn" onclick="startScan()" style="margin-top: 1rem;">Run First Scan</button>
    </div>
</div>
{% endif %}

{% if reports %}
<div class="card">
    <h2><span class="icon">&#128197;</span> Historical Reports</h2>
    <ul class="report-list">
        {% for report in reports %}
        <li>
            <a href="/report/{{ report.date }}">
                <span class="report-date">{{ report.date }}</span>
                {% if loop.first %}
                <span class="badge badge-info">Latest</span>
                {% endif %}
            </a>
        </li>
        {% endfor %}
    </ul>
</div>
{% endif %}
{% endblock %}

{% block extra_script %}
<script>
    let activeFilter = 'all';
    let currentSort = { col: -1, asc: true };

    // Search
    const searchInput = document.getElementById('search');
    const clearBtn = document.getElementById('clear-search');

    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            const term = e.target.value.toLowerCase();
            clearBtn.classList.toggle('visible', term.length > 0);
            applyFilters();
        });
    }

    function clearSearch() {
        if (searchInput) {
            searchInput.value = '';
            clearBtn.classList.remove('visible');
            applyFilters();
            searchInput.focus();
        }
    }

    // TLD Filter
    function filterTLD(tld, el) {
        activeFilter = tld;
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
        applyFilters();
    }

    function applyFilters() {
        const table = document.getElementById('domains-table');
        if (!table) return;

        const rows = table.querySelectorAll('tbody tr');
        const term = searchInput ? searchInput.value.toLowerCase() : '';
        let visibleCount = 0;

        rows.forEach(row => {
            const tld = row.getAttribute('data-tld');
            const text = row.textContent.toLowerCase();
            const matchesTLD = activeFilter === 'all' || tld === activeFilter;
            const matchesSearch = !term || text.includes(term);
            const visible = matchesTLD && matchesSearch;
            row.style.display = visible ? '' : 'none';
            if (visible) visibleCount++;
        });

        const countEl = document.getElementById('result-count');
        if (countEl) {
            countEl.textContent = 'Showing ' + visibleCount + ' domains';
        }
    }

    // Sort
    function sortTable(columnIndex) {
        const table = document.getElementById('domains-table');
        if (!table) return;

        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const headers = table.querySelectorAll('th');

        // Toggle direction
        if (currentSort.col === columnIndex) {
            currentSort.asc = !currentSort.asc;
        } else {
            currentSort.col = columnIndex;
            currentSort.asc = true;
        }

        // Update header indicators
        headers.forEach((h, i) => {
            h.classList.toggle('sorted', i === columnIndex);
            const icon = h.querySelector('.sort-icon');
            if (icon) {
                if (i === columnIndex) {
                    icon.innerHTML = currentSort.asc ? '&#8593;' : '&#8595;';
                } else {
                    icon.innerHTML = '&#8693;';
                }
            }
        });

        rows.sort((a, b) => {
            const aText = a.cells[columnIndex].textContent.trim();
            const bText = b.cells[columnIndex].textContent.trim();
            const aNum = parseFloat(aText);
            const bNum = parseFloat(bText);

            let result;
            if (!isNaN(aNum) && !isNaN(bNum)) {
                result = aNum - bNum;
            } else {
                result = aText.localeCompare(bText);
            }
            return currentSort.asc ? result : -result;
        });

        rows.forEach(row => tbody.appendChild(row));
    }
</script>
{% endblock %}
