{% extends "base.html" %}

{% block meta_description %}Find valuable expiring .se and .nu domains before they drop. Daily scanner powered by Wayback Machine archive data.{% endblock %}

{% block structured_data %}
<script type="application/ld+json">
{
    "@context":"https://schema.org","@type":"WebApplication",
    "name":"DropScan","description":"Find valuable expiring .se and .nu domains.",
    "url":"/","applicationCategory":"UtilitiesApplication","offers":{"@type":"Offer","price":"0","priceCurrency":"USD"}
}
</script>
{% endblock %}

{% block content %}
{% if latest_data %}
<p class="page-title">Tonight's Drops</p>
<p class="page-subtitle">{{ reports[0].date if reports else '' }} ¬∑ {{ latest_data.total_domains }} domains ¬∑ {{ latest_data.domains|selectattr('indexed')|list|length }} indexed</p>

<div class="stats fup">
    <div class="stat-card">
        <div class="stat-value">{{ latest_data.total_domains }}</div>
        <div class="stat-label">Total</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ latest_data.domains|selectattr('tld','equalto','se')|list|length }}</div>
        <div class="stat-label">.se</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ latest_data.domains|selectattr('tld','equalto','nu')|list|length }}</div>
        <div class="stat-label">.nu</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">{{ latest_data.domains|selectattr('indexed')|list|length }}</div>
        <div class="stat-label">Indexed</div>
    </div>
</div>

<div class="card fup">
    <div class="toolbar">
        <span class="card-title" style="margin-bottom:0">Domains</span>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <button class="btn btn-ghost" id="scan-btn-inline" onclick="startScan()" style="font-size:13px;padding:7px 14px">Run Scan</button>
            {% if reports %}
            <a href="/report/{{ reports[0].date }}" class="btn btn-tinted" style="font-size:13px;padding:7px 14px">Full Report</a>
            {% endif %}
        </div>
    </div>

    {% if latest_data.domains %}
    <div class="search-wrap">
        <svg class="ico" viewBox="0 0 16 16" fill="currentColor"><path d="M6.5 0a6.5 6.5 0 014.952 10.73l3.41 3.41a.75.75 0 01-1.06 1.06l-3.41-3.41A6.5 6.5 0 116.5 0zm0 1.5a5 5 0 100 10 5 5 0 000-10z"/></svg>
        <input class="search-input" id="search" type="text" placeholder="Search domains‚Ä¶" autocomplete="off" autocorrect="off" spellcheck="false">
        <button class="search-clear" id="search-clear" onclick="clearSearch()">‚úï</button>
    </div>

    <div class="chip-row">
        <button class="chip on" onclick="setTLD('all',this)">All <span class="n">{{ latest_data.domains|length }}</span></button>
        <button class="chip" onclick="setTLD('se',this)">.se <span class="n">{{ latest_data.domains|selectattr('tld','equalto','se')|list|length }}</span></button>
        <button class="chip" onclick="setTLD('nu',this)">.nu <span class="n">{{ latest_data.domains|selectattr('tld','equalto','nu')|list|length }}</span></button>
        <button class="chip" onclick="setTLD('indexed',this)">Indexed <span class="n">{{ latest_data.domains|selectattr('indexed')|list|length }}</span></button>
    </div>

    <div class="toolbar">
        <span class="rcount" id="rcount">Showing {{ [latest_data.domains|length,50]|min }} of {{ latest_data.domains|length }}</span>
    </div>

    <div class="table-wrap">
        <table id="tbl">
            <thead>
                <tr>
                    <th class="sort" onclick="sortBy(0)">Domain <span class="si">‚áÖ</span></th>
                    <th class="sort" onclick="sortBy(1)">TLD <span class="si">‚áÖ</span></th>
                    <th class="sort" onclick="sortBy(2)">Release <span class="si">‚áÖ</span></th>
                    <th class="sort" onclick="sortBy(3)">Avail <span class="si">‚áÖ</span></th>
                    <th class="sort" onclick="sortBy(4)">Indexed <span class="si">‚áÖ</span></th>
                    <th class="sort" onclick="sortBy(5)">Pages <span class="si">‚áÖ</span></th>
                </tr>
            </thead>
            <tbody>
            {% for domain in latest_data.domains[:50] %}
            <tr data-tld="{{ domain.tld }}" data-indexed="{{ 'yes' if domain.indexed else 'no' }}">
                <td><span class="domain-name">{{ domain.domain }}</span></td>
                <td><span class="tld tld-{{ domain.tld }}">.{{ domain.tld }}</span></td>
                <td style="color:var(--label-2)">{{ domain.release_date }}</td>
                <td>
                    {% if domain.available is none %}<span class="pill pill-m">‚Äî</span>
                    {% elif domain.available %}<span class="pill pill-g">‚úì Free</span>
                    {% else %}<span class="pill pill-r">‚úó Taken</span>{% endif %}
                </td>
                <td>
                    {% if domain.indexed is none %}<span class="pill pill-m">‚Äî</span>
                    {% elif domain.indexed %}<span class="pill pill-g">‚úì Yes</span>
                    {% else %}<span class="pill pill-m">No</span>{% endif %}
                </td>
                <td style="color:var(--label-2)">{{ domain.estimated_pages if domain.estimated_pages else '‚Äî' }}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    {% if latest_data.domains|length > 50 %}
    <div style="text-align:center;margin-top:16px">
        <a href="/report/{{ reports[0].date }}" class="btn btn-tinted">View all {{ latest_data.domains|length }} domains</a>
    </div>
    {% endif %}

    {% else %}
    <div class="empty">
        <div class="ei">üîç</div>
        <p>No domains in latest scan.</p>
        <button class="btn btn-primary" id="scan-btn-inline" onclick="startScan()">Run First Scan</button>
    </div>
    {% endif %}
</div>

{% else %}
<div class="card fup">
    <div class="empty">
        <div class="ei">üöÄ</div>
        <p>No scan results yet. Run your first scan to discover expiring domains.</p>
        <button class="btn btn-primary" id="scan-btn-inline" onclick="startScan()">Run First Scan</button>
    </div>
</div>
{% endif %}

{% if reports %}
<div class="card fup" id="reports-section">
    <p class="card-title">History</p>
    <ul class="report-list">
        {% for report in reports %}
        <li>
            <a href="/report/{{ report.date }}">
                <span class="rd">{{ report.date }}</span>
                <span class="rc">
                    {% if loop.first %}<span class="badge badge-blue">Latest</span>{% endif %}
                    ‚Ä∫
                </span>
            </a>
        </li>
        {% endfor %}
    </ul>
</div>
{% endif %}
{% endblock %}

{% block extra_script %}
<script>
var _tld = 'all';
var _sort = {col:-1, asc:true};
var inp = document.getElementById('search');
var clr = document.getElementById('search-clear');

if (inp) inp.addEventListener('input', function(){
    clr.classList.toggle('on', inp.value.length > 0);
    applyFilters();
});

function clearSearch() { if (inp){inp.value=''; clr.classList.remove('on'); applyFilters(); inp.focus();} }

function setTLD(v, el) {
    _tld = v;
    document.querySelectorAll('.chip-row .chip').forEach(function(c){ c.classList.remove('on'); });
    el.classList.add('on');
    applyFilters();
}

function applyFilters() {
    var tbl = document.getElementById('tbl'); if (!tbl) return;
    var rows = tbl.querySelectorAll('tbody tr');
    var term = inp ? inp.value.toLowerCase() : '';
    var n = 0;
    rows.forEach(function(r){
        var tld = r.getAttribute('data-tld');
        var indexed = r.getAttribute('data-indexed');
        var text = r.textContent.toLowerCase();
        var match = (_tld === 'all' || (_tld === 'indexed' && indexed === 'yes') || tld === _tld)
                    && (!term || text.includes(term));
        r.style.display = match ? '' : 'none';
        if (match) n++;
    });
    var rc = document.getElementById('rcount');
    if (rc) rc.textContent = 'Showing ' + n + ' domains';
}

function sortBy(ci) {
    var tbl = document.getElementById('tbl'); if (!tbl) return;
    var ths = tbl.querySelectorAll('th');
    if (_sort.col === ci) _sort.asc = !_sort.asc;
    else { _sort.col = ci; _sort.asc = true; }
    ths.forEach(function(h,i){
        h.classList.remove('asc','desc');
        var si = h.querySelector('.si');
        if (i === ci) {
            h.classList.add(_sort.asc ? 'asc' : 'desc');
            if (si) si.textContent = _sort.asc ? '‚Üë' : '‚Üì';
        } else if (si) si.textContent = '‚áÖ';
    });
    var tbody = tbl.querySelector('tbody');
    var rows = Array.from(tbody.querySelectorAll('tr'));
    rows.sort(function(a,b){
        var at = a.cells[ci] ? a.cells[ci].textContent.trim() : '';
        var bt = b.cells[ci] ? b.cells[ci].textContent.trim() : '';
        var an = parseFloat(at), bn = parseFloat(bt), r;
        if (!isNaN(an) && !isNaN(bn)) r = an - bn; else r = at.localeCompare(bt);
        return _sort.asc ? r : -r;
    });
    rows.forEach(function(r){ tbody.appendChild(r); });
}
</script>
{% endblock %}
